# Двухсторонняя интеграция amoCRM и Google Sheets

Этот проект реализует автоматическую двухстороннюю синхронизацию данных между amoCRM и Google Sheets с использованием FastAPI.

**Автор**: `ваше_имя`
**Стек**: Python, FastAPI, Gspread, HTTPL, APScheduler

---

## Возможности

1.  **Из Google Sheets в amoCRM (синхронизация по расписанию, раз в 5 минут):**

    - **Создание сделок**: При добавлении новой строки в Google Таблицу, в amoCRM автоматически создается новая сделка.
    - **Обновление сделок**: При изменении данных в существующей строке (например, суммы), обновляются соответствующие поля в связанной сделке amoCRM.
    - **Связь**: Связь между строкой и сделкой устанавливается по `lead_id`, который записывается в первую колонку таблицы после создания сделки.

2.  **Из amoCRM в Google Sheets (синхронизация через вебхуки, мгновенно):**
    - **Обновление данных**: При изменении сделки в amoCRM (например, смена этапа или суммы), соответствующие данные в связанной строке Google Таблицы обновляются.

---

## Настройка и запуск

### Шаг 1: Подготовка

- Клонируйте репозиторий на свой компьютер.
- Установите Python 3.10 или выше.

### Шаг 2: Настройка доступов

#### Google Cloud

1.  Создайте сервисный аккаунт в [Google Cloud Console](https://console.cloud.google.com/).
2.  Включите для вашего проекта **Google Sheets API** и **Google Drive API**.
3.  Создайте и скачайте JSON-ключ для сервисного аккаунта.
4.  Переименуйте скачанный файл в `service-account-key.json` и поместите его в папку `credentials`.

#### Google Sheets

1.  Создайте новую Google Таблицу.
2.  Нажмите кнопку "Поделиться" (Share) и предоставьте права **Редактора** email-адресу вашего сервисного аккаунта (его можно найти внутри `service-account-key.json` в поле `client_email`).
3.  Настройте заголовки в первой строке таблицы. Обязательные колонки:
    - `lead_id` (самая первая колонка, A)
    - `Имя`
    - `Телефон (Контакт)`
    - `Email (Контакт)`
    - `Сумма`
    - `Статус`

#### amoCRM

1.  Зайдите в ваш аккаунт amoCRM.
2.  Перейдите в `Настройки` -> `Интеграции` и создайте новую "Внешнюю интеграцию".
3.  На вкладке "Ключи и доступы" скопируйте **Секретный ключ**, **ID интеграции** и **Долгосрочный токен**. Для этого проекта нам понадобится только **Долгосрочный токен**.

### Шаг 3: Конфигурация проекта

1.  Создайте файл `.env` в корневой папке проекта, скопировав содержимое из `.env.example`.
2.  Заполните `.env` вашими данными:

    ```dotenv
    # Субдомен вашего аккаунта (например, "mycompany" из mycompany.amocrm.ru)
    AMOCRM_SUBDOMAIN="ВАШ_СУБДОМЕН"

    # Долгосрочный токен, полученный в настройках интеграции
    AMOCRM_INTEGRATION_TOKEN="ВАШ_ДОЛГОСРОЧНЫЙ_ТОКЕН"

    # ID вашей Google Таблицы (из URL: /spreadsheets/d/THIS_IS_THE_ID/edit)
    GOOGLE_SHEET_ID="ВАШ_GOOGLE_SHEET_ID"

    # Путь к файлу ключа сервисного аккаунта (менять не нужно, если вы следовали инструкции)
    GOOGLE_APPLICATION_CREDENTIALS="credentials/service-account-key.json"
    ```

3.  Откройте файл `google-API-amoCRM/app/sync_sheets_to_amo.py` и укажите ID вашей воронки и этапа, куда должны создаваться новые сделки.
    ```python
    PIPELINE_ID = 123456  # <-- ID вашей воронки
    STATUS_ID = 789101   # <-- ID этапа в этой воронке
    ```

### Шаг 4: Запуск

1.  Создайте и активируйте виртуальное окружение:
    ```bash
    python -m venv .venv
    source .venv/bin/activate  # для Windows: .venv\Scripts\activate
    ```
2.  Установите все зависимости:
    ```bash
    pip install .
    ```
3.  Запустите веб-сервер:
    ```bash
    uvicorn main:app --reload
    ```
    Сервер будет доступен по адресу `http://127.0.0.1:8000`.

---

## Тестирование вебхуков (amoCRM -> Sheets)

Для локального тестирования вам понадобится `ngrok`, чтобы сделать ваш локальный сервер доступным из интернета.

1.  Скачайте и запустите `ngrok`:
    ```bash
    ./ngrok http 8000
    ```
2.  Скопируйте `https` адрес, который предоставит `ngrok` (например, `https://abcd-1234.ngrok-free.app`).
3.  В настройках вашей интеграции в amoCRM, в поле **"Ссылка для отправки вебхуков"**, вставьте этот адрес и добавьте `/webhook/amocrm`.
    > `https://abcd-1234.ngrok-free.app/webhook/amocrm`
4.  Активируйте события, на которые должен реагировать вебхук (например, "Сделка изменена").
5.  Сохраните. Теперь при изменении сделки в amoCRM, данные будут отправляться на ваш локальный сервер и обновляться в таблице.
